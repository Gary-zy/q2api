# Q2API 中文技术文档

## 项目概述

**Q2API** 是一个 API 桥接服务，将 Amazon Q Developer 转换为兼容 OpenAI 和 Claude API 的端点。支持多账号管理、流式响应和智能负载均衡。

## 核心架构

### 请求处理流程

```
客户端请求 (OpenAI/Claude SDK)
    ↓
FastAPI 服务器 (app.py)
    ├─ /v1/chat/completions (OpenAI 格式)
    └─ /v1/messages (Claude 格式)
    ↓
请求转换 (claude_converter.py)
    ├─ 消息格式转换
    ├─ 工具定义映射
    └─ 多模态内容处理
    ↓
账号池选择 (随机或懒加载策略)
    ↓
Token 刷新 (按需或后台自动)
    ↓
Amazon Q API 请求 (replicate.py)
    ├─ OIDC 认证
    └─ 二进制事件流解析
    ↓
响应转换 (claude_stream.py)
    └─ 生成 Claude SSE 格式响应
    ↓
返回客户端
```

### 核心模块说明

| 模块 | 功能职责 |
|------|---------|
| **app.py** | FastAPI 主应用，API 端点定义，账号管理，Token 刷新 |
| **db.py** | 数据库抽象层，支持 SQLite/PostgreSQL/MySQL |
| **replicate.py** | Amazon Q 请求复刻，二进制事件流协议解析 |
| **auth_flow.py** | 设备授权流程（URL 登录），AWS OIDC 集成 |
| **claude_types.py** | Claude API 类型定义（Pydantic 模型） |
| **claude_converter.py** | Claude → Amazon Q 请求格式转换 |
| **claude_parser.py** | Amazon Q 事件流解析（提取文本、引用、错误） |
| **claude_stream.py** | Amazon Q → Claude SSE 响应生成 |

## 技术实现细节

### 1. 消息格式转换

**Claude 格式 → Amazon Q 格式**

```python
# Claude 消息格式
{
  "role": "user",
  "content": "你好"
}

# 转换为 Amazon Q 格式
{
  "userInputMessage": {
    "content": "你好"
  }
}
```

**关键转换逻辑：**
- `user` 角色 → `userInputMessage`
- `assistant` 角色 → `aiMessage`
- 工具调用 → `toolUseBlock`
- 工具结果 → `toolResultBlock`
- 图片内容 → `imageBlock` (base64 编码)

### 2. 账号管理机制

**数据库表结构：**
```sql
CREATE TABLE accounts (
    id TEXT PRIMARY KEY,              -- UUID
    label TEXT,                       -- 账号标签
    clientId TEXT,                    -- OIDC 客户端 ID
    clientSecret TEXT,                -- OIDC 客户端密钥
    refreshToken TEXT,                -- 刷新令牌
    accessToken TEXT,                 -- 访问令牌
    enabled INTEGER DEFAULT 1,        -- 1=启用, 0=禁用
    error_count INTEGER DEFAULT 0,    -- 连续错误次数
    success_count INTEGER DEFAULT 0,  -- 成功请求次数
    last_refresh_time TEXT,           -- 最后刷新时间
    last_refresh_status TEXT,         -- 最后刷新状态
    created_at TEXT,                  -- 创建时间
    updated_at TEXT                   -- 更新时间
);
```

**账号选择策略：**

1. **默认模式**：从所有 `enabled=1` 的账号中随机选择
2. **懒加载池模式**（`LAZY_ACCOUNT_POOL_ENABLED=true`）：
   - 从排序后的前 N 个账号中选择
   - 减少数据库查询次数
   - 可配置排序字段和池大小

**自动禁用机制：**
- 当 `error_count >= MAX_ERROR_COUNT` 时自动禁用账号
- 成功请求后重置 `error_count` 为 0
- 增加 `success_count` 计数

### 3. Token 自动刷新

**两种刷新机制：**

1. **后台定时刷新**
   - 每 5 分钟运行一次
   - 刷新超过 25 分钟未更新的 Token
   - 更新 `last_refresh_time` 和 `last_refresh_status`

2. **请求时按需刷新**
   - 当 `accessToken` 缺失时触发
   - 自动重试失败的请求
   - 可通过 API 手动触发刷新

**OIDC 刷新流程：**
```
POST https://oidc.us-east-1.amazonaws.com/token
{
  "grantType": "refresh_token",
  "clientId": "...",
  "clientSecret": "...",
  "refreshToken": "..."
}
→ 返回新的 accessToken 和 refreshToken
```

### 4. 二进制事件流协议

Amazon Q 使用自定义二进制协议（非标准 SSE），`replicate.py` 实现了完整的解析器：

**协议结构：**
```
[4字节前导] 总长度 + 头部长度
[变长头部] 名称-值对（带类型编码）
[负载数据] JSON 或二进制数据
[4字节校验] CRC32 校验和
```

**事件类型：**
- `assistantResponseEvent` → 文本内容
- `codeReferenceEvent` → 代码引用
- `supplementaryWebLinksEvent` → 网页链接
- `error` → 错误信息

### 5. 数据库后端自动选择

`db.py` 根据 `DATABASE_URL` 自动选择数据库类型：

```python
# 空值或未设置 → SQLite
DATABASE_URL=""  # 使用 data.sqlite3

# PostgreSQL
DATABASE_URL="postgres://user:pass@host:5432/db"

# MySQL
DATABASE_URL="mysql://user:pass@host:3306/db"
```

所有后端实现相同的 `DatabaseBackend` 接口，确保代码兼容性。

## 环境变量配置

### 核心配置

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `DATABASE_URL` | `""` | 数据库连接 URL（空=SQLite） |
| `OPENAI_KEYS` | `""` | API Key 白名单（逗号分隔，空=开发模式） |
| `TOKEN_COUNT_MULTIPLIER` | `1.0` | Token 计数倍率 |
| `MAX_ERROR_COUNT` | `100` | 错误阈值（超过自动禁用账号） |
| `HTTP_PROXY` | `""` | HTTP 代理地址 |
| `ENABLE_CONSOLE` | `true` | 启用 Web 管理控制台 |
| `ADMIN_PASSWORD` | `admin` | 控制台登录密码 |
| `PORT` | `8000` | 服务端口 |

### 懒加载池配置

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `LAZY_ACCOUNT_POOL_ENABLED` | `false` | 启用懒加载账号池 |
| `LAZY_ACCOUNT_POOL_SIZE` | `20` | 聊天请求的账号池大小 |
| `LAZY_ACCOUNT_POOL_REFRESH_OFFSET` | `10` | 刷新任务的偏移量 |
| `LAZY_ACCOUNT_POOL_ORDER_BY` | `created_at` | 排序字段（created_at/id/success_count） |
| `LAZY_ACCOUNT_POOL_ORDER_DESC` | `false` | 是否降序排序 |

## API 端点说明

### 公开端点

| 方法 | 路径 | 说明 |
|------|------|------|
| `POST` | `/v1/chat/completions` | OpenAI Chat Completions API |
| `POST` | `/v1/messages` | Claude Messages API |
| `POST` | `/v1/messages/count_tokens` | Token 计数（不发送请求） |
| `GET` | `/healthz` | 健康检查 |
| `GET` | `/docs` | Swagger UI 文档 |

### 管理端点（需要登录）

| 方法 | 路径 | 说明 |
|------|------|------|
| `POST` | `/api/login` | 管理员登录 |
| `GET` | `/login` | 登录页面 |
| `GET` | `/` | Web 管理控制台 |
| `POST` | `/v2/accounts` | 创建账号 |
| `POST` | `/v2/accounts/feed` | 批量创建账号 |
| `GET` | `/v2/accounts` | 列出所有账号 |
| `GET` | `/v2/accounts/{id}` | 获取账号详情 |
| `PATCH` | `/v2/accounts/{id}` | 更新账号 |
| `DELETE` | `/v2/accounts/{id}` | 删除账号 |
| `POST` | `/v2/accounts/{id}/refresh` | 刷新 Token |
| `POST` | `/v2/auth/start` | 启动设备授权 |
| `GET` | `/v2/auth/status/{authId}` | 查询授权状态 |
| `POST` | `/v2/auth/claim/{authId}` | 等待并创建账号（5分钟超时） |

## 开发指南

### 本地开发环境搭建

```bash
# 1. 安装依赖
uv venv
uv pip install -r requirements.txt

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 3. 启动开发服务器（热重载）
uvicorn app:app --reload --host 0.0.0.0 --port 8000
```

### Docker 部署

```bash
# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 测试端点

```bash
# 健康检查
curl http://localhost:8000/healthz

# 测试 OpenAI 端点
curl -X POST http://localhost:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-sonnet-4",
    "messages": [{"role": "user", "content": "你好"}]
  }'

# 测试 Claude 端点
curl -X POST http://localhost:8000/v1/messages \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-sonnet-4.5",
    "max_tokens": 100,
    "messages": [{"role": "user", "content": "你好"}]
  }'
```

## 常见开发任务

### 添加新的 API 端点

1. 在 `app.py` 中定义 Pydantic 请求/响应模型
2. 使用 `@app.post()` 或 `@app.get()` 装饰器添加端点
3. 需要账号选择的端点使用 `Depends(require_account)`
4. 管理员端点使用 `Depends(verify_admin_password)`
5. 更新账号统计：`await _update_stats(account_id, success: bool)`

### 修改 Claude → Amazon Q 转换逻辑

编辑 `claude_converter.py`：
- `convert_claude_to_amazonq_request()` - 主转换函数
- `convert_tool()` - 工具定义映射
- `extract_images_from_content()` - 多模态内容处理

### 修改事件流解析

编辑 `claude_parser.py`：
- `EventStreamParser.parse_stream()` - 主解析逻辑
- `extract_event_info()` - 事件类型提取

### 数据库架构变更

1. 修改 `db.py` 中的架构（三个后端：SQLite、PostgreSQL、MySQL）
2. 为现有部署创建迁移脚本（`scripts/migrate_db.py`）
3. 测试所有三个数据库后端

## 故障排查

### 常见问题

**401 Unauthorized（未授权）**
- 检查 `OPENAI_KEYS` 配置
- 确认至少有一个账号是启用状态（`enabled=1`）
- 验证 API Key 在白名单中

**502 Bad Gateway（网关错误）**
- Token 刷新失败（检查 `last_refresh_status`）
- 网络连接问题
- 代理配置错误

**空响应**
- 账号因错误过多被禁用
- Amazon Q 服务不可用
- 请求格式无效

### 调试步骤

1. 检查服务健康：`curl http://localhost:8000/healthz`
2. 列出账号：`curl http://localhost:8000/v2/accounts -H "Authorization: Bearer <token>"`
3. 检查账号状态：查看 `enabled`、`error_count`、`last_refresh_status`
4. 测试 Token 刷新：`curl -X POST http://localhost:8000/v2/accounts/{id}/refresh`
5. 查看日志：`docker-compose logs -f` 或控制台输出

## 安全建议

1. **生产环境必须修改 `ADMIN_PASSWORD` 为强密码**
2. **配置 `OPENAI_KEYS` 白名单**
3. **使用 HTTPS 反向代理**（Nginx + Let's Encrypt）
4. **定期备份数据库**
5. **限制数据库访问权限**
6. **配置防火墙规则**

## 性能优化

### 多进程部署

```bash
# 使用 4 个 worker 进程
uvicorn app:app --host 0.0.0.0 --port 8000 --workers 4
```

### 启用懒加载账号池

```bash
# .env 配置
LAZY_ACCOUNT_POOL_ENABLED="true"
LAZY_ACCOUNT_POOL_SIZE=50
LAZY_ACCOUNT_POOL_ORDER_BY="success_count"
LAZY_ACCOUNT_POOL_ORDER_DESC="true"
```

### Nginx 反向代理配置

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # SSE 支持
        proxy_buffering off;
        proxy_cache off;
    }
}
```

## 项目文件结构

```
q2api/
├── app.py                    # FastAPI 主应用
├── db.py                     # 数据库抽象层
├── replicate.py              # Amazon Q 请求复刻
├── auth_flow.py              # 设备授权登录
├── claude_types.py           # Claude API 类型定义
├── claude_converter.py       # Claude → Amazon Q 转换
├── claude_parser.py          # 事件流解析
├── claude_stream.py          # Claude SSE 响应生成
├── requirements.txt          # Python 依赖
├── .env.example              # 环境变量示例
├── docker-compose.yml        # Docker Compose 配置
├── Dockerfile                # Docker 镜像配置
├── data.sqlite3              # SQLite 数据库（自动创建）
├── templates/
│   └── streaming_request.json  # Amazon Q 请求模板
├── frontend/
│   ├── index.html            # Web 管理控制台
│   └── login.html            # 登录页面
└── scripts/
    ├── account_stats.py      # 账号统计脚本
    ├── retry_failed_accounts.py  # 重试失败账号
    └── reset_accounts.py     # 重置账号脚本
```

## 技术栈

- **后端框架**：FastAPI + Python 3.11+
- **数据库**：SQLite3 (aiosqlite) / PostgreSQL (asyncpg) / MySQL (aiomysql)
- **HTTP 客户端**：httpx（异步 + 代理支持）
- **Token 计数**：tiktoken
- **前端**：纯 HTML/CSS/JavaScript
- **认证**：AWS OIDC 设备授权流程

## 许可证

本项目仅供学习和测试使用。

## 致谢

- [amq2api](https://github.com/mucsbr/amq2api) - Claude 消息格式转换参考
- FastAPI - 现代 Python Web 框架
- Amazon Q Developer - 底层 AI 服务
