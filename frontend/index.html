<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>Q2API · Console by 张扬2025年11月28日17:09:54</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      /* 调色盘：深夜霓虹 */
      --bg-body: #030711;
      --bg-panel: rgba(18, 24, 38, 0.9);
      --bg-subtle: #101727;
      
      --border: rgba(255, 255, 255, 0.08);
      --border-subtle: rgba(255, 255, 255, 0.05);
      
      --text-main: #f8fafc;
      --text-muted: #9ba3b4;
      --text-dim: #5f6880;

      --accent: #22d3ee; /* 青蓝 */
      --accent-2: #7cfb6b; /* 荧光绿 */
      --accent-hover: #0ea5e9;
      --accent-glow: rgba(34, 211, 238, 0.24);

      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
    }

    /* 基础重置 */
    * { box-sizing: border-box; outline: none; }
    html, body { height: 100%; margin: 0; }
    
    body {
      background: radial-gradient(circle at 10% 20%, rgba(34, 211, 238, 0.12), transparent 26%),
                  radial-gradient(circle at 80% 0%, rgba(124, 251, 107, 0.14), transparent 30%),
                  radial-gradient(circle at 50% 80%, rgba(14, 165, 233, 0.18), transparent 28%),
                  var(--bg-body);
      color: var(--text-main);
      font-family: "Sora", "Space Grotesk", "Inter", ui-sans-serif, system-ui, -apple-system, sans-serif;
      line-height: 1.55;
      font-size: 14px;
      padding-bottom: 48px;
      letter-spacing: 0.01em;
    }

    /* 布局容器 */
    .container {
      max-width: 1360px;
      margin: 0 auto;
      padding: 28px 24px 0;
    }

    /* 头部区域 */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-subtle);
    }

    h1 {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.6px;
      margin: 0;
      background: linear-gradient(120deg, #e2f3ff, #9ae6ff 45%, #7cfb6b 90%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-transform: uppercase;
    }

    /* 导航 Tabs - 胶囊风格 */
    .nav-tabs {
      display: inline-flex;
      background: rgba(255, 255, 255, 0.05);
      padding: 5px;
      border-radius: 999px;
      gap: 4px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    }

    .tab-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.03em;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:hover { color: var(--text-main); transform: translateY(-1px); }
    .tab-btn.active {
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(124, 251, 107, 0.2));
      color: var(--text-main);
      box-shadow: 0 12px 35px rgba(34, 211, 238, 0.25);
      border: 1px solid rgba(124, 251, 107, 0.2);
    }

    /* 内容面板 */
    .tab-pane { display: none; animation: fadeIn 0.3s ease; }
    .tab-pane.active { display: block; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .panel {
      position: relative;
      background: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      overflow: hidden;
      backdrop-filter: blur(8px);
    }
    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.07), transparent 38%),
                  radial-gradient(circle at 90% 10%, rgba(124, 251, 107, 0.07), transparent 32%);
      opacity: 0.9;
      pointer-events: none;
    }
    .panel > * { position: relative; z-index: 1; }

    /* ---------------- 表格样式 (核心修改) ---------------- */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(255,255,255,0.01);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      text-align: left;
    }

    thead {
      background: linear-gradient(90deg, rgba(34, 211, 238, 0.12), rgba(124, 251, 107, 0.08));
    }

    th {
      padding: 12px 16px;
      color: var(--text-muted);
      font-weight: 600;
      white-space: nowrap;
      border-bottom: 1px solid var(--border);
    }
    .list { max-height:600px; overflow:auto; padding:2px; }
    .list::-webkit-scrollbar { width:8px; }
    .list::-webkit-scrollbar-track { background:rgba(0,0,0,.2); border-radius:4px; }
    .list::-webkit-scrollbar-thumb { background:rgba(79,143,255,.3); border-radius:4px; }
    .list::-webkit-scrollbar-thumb:hover { background:rgba(79,143,255,.5); }
    .accounts-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:16px; }
    @media(max-width:1600px){ .accounts-grid { grid-template-columns:repeat(4, 1fr); } }
    @media(max-width:1280px){ .accounts-grid { grid-template-columns:repeat(3, 1fr); } }
    @media(max-width:900px){ .accounts-grid { grid-template-columns:repeat(2, 1fr); } }
    @media(max-width:600px){ .accounts-grid { grid-template-columns:1fr; } }
    .card {
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      background:linear-gradient(145deg,rgba(12,19,34,.6),rgba(10,14,26,.8));
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:0 4px 16px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.02);
      transition:all .2s;
      cursor:pointer;
    }
    .card:hover { border-color:rgba(79,143,255,.3); box-shadow:0 6px 20px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.03); transform:translateY(-2px); }
    .card-header { display:flex; align-items:center; gap:8px; }
    .card-title { font-weight:600; font-size:14px; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .card-status { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .card-status.enabled { background:var(--ok); box-shadow:0 0 8px var(--ok); }
    .card-status.disabled { background:var(--muted); }
    .card-stats { display:flex; flex-direction:column; gap:8px; font-size:12px; }
    .card-stat { display:flex; flex-direction:column; gap:4px; }
    .card-stat-header { display:flex; justify-content:space-between; align-items:center; }
    .card-stat-label { color:var(--muted); font-size:11px; }
    .card-stat-value { font-weight:600; font-size:13px; }
    .card-stat-value.success { color:var(--ok); }
    .card-stat-value.error { color:var(--danger); }
    .progress-bar { height:6px; background:rgba(255,255,255,.05); border-radius:3px; overflow:hidden; }
    .progress-fill { height:100%; transition:width .3s; border-radius:3px; }
    .progress-fill.success { background:linear-gradient(90deg,var(--ok),#48ffa0); }
    .progress-fill.error { background:linear-gradient(90deg,var(--danger),#ff6b7a); }
    .card-id { font-family:monospace; font-size:11px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; }
    .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .code {
      background:var(--code);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      color:#d8e8ff;
      max-height:300px;
      overflow:auto;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.6;
      box-shadow:inset 0 2px 4px rgba(0,0,0,.3);
    }
    .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
    .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
    .badge-neutral { background: rgba(161, 161, 170, 0.15); color: var(--text-muted); border: 1px solid rgba(161, 161, 170, 0.2); }

    .token-dot {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--border);
      margin-right: 4px;
    }
    .token-dot.active { background: var(--success); box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }

    /* 按钮样式 */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 16px;
      border-radius: var(--radius-md);
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
      gap: 6px;
      letter-spacing: 0.02em;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      color: #041018;
      box-shadow: 0 10px 30px rgba(34, 211, 238, 0.35);
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 14px 36px rgba(34, 211, 238, 0.42); }
    
    .btn-ghost { background: rgba(255,255,255,0.04); color: var(--text-main); border: 1px solid var(--border); }
    .btn-ghost:hover { background: rgba(255,255,255,0.07); border-color: rgba(255,255,255,0.12); }

    .btn-icon { padding: 7px; border-radius: var(--radius-sm); color: var(--text-muted); background: rgba(255,255,255,0.03); border: 1px solid var(--border); }
    .btn-icon:hover { background: rgba(255,255,255,0.08); color: var(--text-main); transform: translateY(-1px); }
    .btn-icon.danger:hover { background: rgba(239, 68, 68, 0.12); color: var(--danger); }

    /* 开关 (Switch) */
    .switch {
      position: relative;
      display: inline-block;
      width: 36px;
      height: 20px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: var(--border);
      transition: .3s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px; width: 16px;
      left: 2px; bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--success); }
    input:checked + .slider:before { transform: translateX(16px); }

    /* 表单元素 */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    label { color: var(--text-muted); font-size: 12px; font-weight: 600; }
    input, textarea, select {
      background: var(--bg-body);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 10px 12px;
      border-radius: var(--radius-md);
      font-size: 14px;
      transition: border 0.2s;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
    textarea { min-height: 100px; font-family: 'SFMono-Regular', monospace; font-size: 12px; }

    /* 模态框 (Modal) */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--bg-panel);
      width: 100%; max-width: 500px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 24px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }
    .modal-header { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; }
    .modal-footer { margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px; }

    /* 工具类 */
    .text-mono { font-family: 'SFMono-Regular', monospace; }
    .flex-row { display: flex; gap: 12px; align-items: center; }
    .spacer { flex: 1; }
    
    /* Code block for chat */
    .code-preview {
      background: #0d0d0d;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      color: #a8b8d8;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }

  </style>
</head>
<body>
  <div class="container">


<div class="container">
  <header>
    <h1>Q2API Console by zhang</h1>
    <div class="nav-tabs">
      <button class="tab-btn active" onclick="switchTab('accounts')">账号列表</button>
      <button class="tab-btn" onclick="switchTab('create')">新建账号</button>
      <button class="tab-btn" onclick="switchTab('login')">URL 登录</button>
      <button class="tab-btn" onclick="switchTab('chat')">Chat 调试</button>
    </div>
  </header>

    <div id="tab-accounts" class="tab-content active">
      <div class="panel">
        <h2>账号管理</h2>
        <div class="row">
          <button class="btn-secondary" onclick="loadAccounts()">刷新列表</button>
          <button class="btn-secondary" onclick="exportAccounts()">导出</button>
          <button class="btn-secondary" onclick="document.getElementById('importFile').click()">导入</button>
          <input type="file" id="importFile" accept=".json" style="display:none" onchange="importAccounts(event)">
        </div>
        <div class="list" id="accounts"></div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width: 50px">状态</th>
              <th>标签 (Label)</th>
              <th>Client ID / ID</th>
              <th>Tokens</th>
              <th>统计 (成功/失败)</th>
              <th style="text-align: right">操作</th>
            </tr>
          </thead>
          <tbody id="accounts-table-body">
            <!-- JS 渲染 -->
          </tbody>
        </table>
      </div>
      <div id="empty-state" style="text-align:center; padding: 40px; color: var(--text-muted); display:none;">
        暂无账号数据
      </div>
    </div>
  </div>

  <!-- Tab: 新建账号 -->
  <div id="tab-create" class="tab-pane">
    <div class="panel" style="max-width: 800px; margin: 0 auto;">
      <h2 style="margin-bottom:24px;">手动添加账号</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>Label (标签)</label>
          <input id="new_label" placeholder="例如: My Personal Key" />
        </div>
        <div class="form-group">
           <label>启用状态</label>
           <div class="flex-row">
             <label class="switch">
               <input id="new_enabled" type="checkbox" checked />
               <span class="slider"></span>
             </label>
             <span style="font-size:12px; color:var(--text-muted)">仅启用账号会被调度</span>
           </div>
        </div>
        <div class="form-group">
          <label>Client ID</label>
          <input id="new_clientId" class="text-mono" />
        </div>
        <div class="form-group">
          <label>Client Secret</label>
          <input id="new_clientSecret" type="password" class="text-mono" />
        </div>
        <div class="form-group">
          <label>Refresh Token</label>
          <input id="new_refreshToken" class="text-mono" />
        </div>
        <div class="form-group">
          <label>Access Token</label>
          <input id="new_accessToken" class="text-mono" />
        </div>
        <div class="form-group" style="grid-column: 1/-1;">
          <label>Metadata (JSON)</label>
          <textarea id="new_other" placeholder='{"note": "备注信息"}'></textarea>
        </div>
      </div>
      <div style="margin-top: 24px; text-align: right;">
        <button class="btn btn-primary" onclick="createAccount()">创建账号</button>
      </div>
    </div>
  </div>

  <!-- Tab: URL 登录 -->
  <div id="tab-login" class="tab-pane">
    <div class="panel" style="max-width: 600px; margin: 0 auto;">
      <h2 style="margin-bottom: 20px;">Device Code Login</h2>
      <div class="form-group" style="margin-bottom: 20px;">
        <label>新建账号标签</label>
        <input id="auth_label" placeholder="自动登录账号" />
      </div>
      <div class="flex-row" style="margin-bottom: 24px;">
        <button class="btn btn-primary" onclick="startAuth()">1. 获取登录链接</button>
        <button class="btn btn-ghost" onclick="claimAuth()">2. 我已登录，获取 Token</button>
      </div>
      
      <div class="code-preview" id="auth_info">等待操作...</div>
    </div>
  </div>

  <!-- Tab: Chat 测试 -->
  <div id="tab-chat" class="tab-pane">
    <div class="panel">
      <div class="flex-row" style="margin-bottom: 20px;">
        <div class="form-group" style="width: 200px;">
          <label>Model</label>
          <input id="model" value="claude-sonnet-4" />
        </div>
        <div class="form-group">
          <label>Stream</label>
          <select id="stream">
            <option value="false">关闭 (Block)</option>
            <option value="true">开启 (SSE)</option>
          </select>
        </div>
        <div class="spacer"></div>
        <button class="btn btn-primary" onclick="send()">发送请求</button>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
          <label>Messages (JSON)</label>
          <textarea id="messages" style="height: 400px; font-family: monospace;">[
  {"role":"system","content":"你是一个乐于助人的助手"},
  {"role":"user","content":"你好，请用一句话介绍你自己"}
]</textarea>
        </div>
        <div class="form-group">
          <label>Response</label>
          <div id="out" class="code-preview" style="height: 400px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 编辑模态框 -->
<div id="edit-modal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <span>编辑账号</span>
      <button class="btn-icon" onclick="closeEditModal()">✕</button>
    </div>
    <div class="form-group" style="margin-bottom:16px;">
      <label>Label</label>
      <input id="edit_label" />
    </div>
    <div class="form-group" style="margin-bottom:16px;">
      <label>Access Token (覆盖)</label>
      <input id="edit_accessToken" class="text-mono" placeholder="留空则不修改" />
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeEditModal()">取消</button>
      <button class="btn btn-primary" onclick="submitEdit()">保存修改</button>
    </div>
  </div>
</div>

<script>
// --- 基础工具 ---
function api(path) {
  return ('/' + (path || '').replace(/^\/+/, '')).replace(/\/{2,}/g, '/');
}

function getAuthHeaders() {
  const p = localStorage.getItem('adminPassword');
  return p ? { 'Authorization': `Bearer ${p}` } : {};
}

async function authFetch(url, options = {}) {
  const headers = { ...getAuthHeaders(), ...options.headers };
  const r = await fetch(url, { ...options, headers });
  if (r.status === 401) {
    localStorage.removeItem('adminPassword');
    window.location.href = '/login.html'; // 假设你的登录页是 login.html
    throw new Error('Unauthorized');
  }
  return r;
}

// --- 页面逻辑 ---
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  
  // 简单的事件委托查找或直接匹配
  const btns = document.querySelectorAll('.tab-btn');
  // 这里的逻辑稍微简化，依赖 HTML 结构顺序或点击事件
  event.target.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

// --- 账号管理 (表格渲染) ---
let currentAccounts = [];
let editingId = null;

function renderTable(list) {
  currentAccounts = list;
  const tbody = document.getElementById('accounts-table-body');
  const empty = document.getElementById('empty-state');
  tbody.innerHTML = '';

function getAuthHeaders() {
  const password = getAuthPassword();
  if (!password) return {};
  return { 'Authorization': `Bearer ${password}` };
}

// Authenticated fetch wrapper
async function authFetch(url, options = {}) {
  const headers = { ...getAuthHeaders(), ...options.headers };
  const response = await fetch(url, { ...options, headers });

  if (response.status === 401) {
    localStorage.removeItem('adminPassword');
    window.location.href = '/login';
    throw new Error('Unauthorized');
  }

  return response;
}

// Check authentication on page load - removed, combined with loadAccounts below

// Virtual scroll state
let accountsData = [];
let virtualScroll = null;

// Create account card element (small card for grid)
function createAccountCard(acc) {
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.accountId = acc.id;
  card.onclick = () => showAccountDetail(acc);

  const header = document.createElement('div');
  header.className = 'card-header';

  const status = document.createElement('div');
  status.className = 'card-status ' + (acc.enabled ? 'enabled' : 'disabled');

  const title = document.createElement('div');
  title.className = 'card-title';
  title.textContent = acc.label || '(无标签)';

  header.appendChild(status);
  header.appendChild(title);
  card.appendChild(header);

  const stats = document.createElement('div');
  stats.className = 'card-stats';

  const successCount = acc.success_count || 0;
  const errorCount = acc.error_count || 0;
  const total = successCount + errorCount || 1;
  const successPercent = (successCount / total) * 100;
  const errorPercent = (errorCount / total) * 100;

  const successStat = document.createElement('div');
  successStat.className = 'card-stat';
  successStat.innerHTML = `
    <div class="card-stat-header">
      <span class="card-stat-label">成功</span>
      <span class="card-stat-value success">${successCount}</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill success" style="width:${successPercent}%"></div>
    </div>
  `;

  const errorStat = document.createElement('div');
  errorStat.className = 'card-stat';
  errorStat.innerHTML = `
    <div class="card-stat-header">
      <span class="card-stat-label">错误</span>
      <span class="card-stat-value error">${errorCount}</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill error" style="width:${errorPercent}%"></div>
    </div>
  `;

  stats.appendChild(successStat);
  stats.appendChild(errorStat);
  card.appendChild(stats);

  const idDiv = document.createElement('div');
  idDiv.className = 'card-id';
  idDiv.textContent = acc.id;
  card.appendChild(idDiv);

  return card;
}

// Show account detail modal
function showAccountDetail(acc) {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;';
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

  const content = document.createElement('div');
  content.className = 'panel';
  content.style.cssText = 'max-width:800px;width:100%;max-height:90vh;overflow:auto;';

  const header = document.createElement('div');
  header.className = 'row';
  header.style.marginBottom = '16px';
  header.style.gap = '8px';

  const labelInput = document.createElement('input');
  labelInput.value = acc.label || '';
  labelInput.placeholder = '标签';
  labelInput.style.flex = '1';

  const saveLabel = document.createElement('button');
  saveLabel.className = 'btn-secondary';
  saveLabel.textContent = '保存标签';
  saveLabel.onclick = async () => {
    await updateAccount(acc.id, { label: labelInput.value });
    modal.remove();
  };

  const closeBtn = document.createElement('button');
  closeBtn.className = 'btn-secondary';
  closeBtn.textContent = '关闭';
  closeBtn.onclick = () => modal.remove();

  header.appendChild(labelInput);
  header.appendChild(saveLabel);
  header.appendChild(closeBtn);
  content.appendChild(header);

  const meta = document.createElement('div');
  meta.className = 'kvs mono';
  function row(k, v, color) {
    const kEl = document.createElement('div'); kEl.className = 'muted'; kEl.textContent = k;
    if (color) kEl.style.color = color;
    const vEl = document.createElement('div'); vEl.textContent = v ?? '';
    if (color) vEl.style.color = color;
    meta.appendChild(kEl); meta.appendChild(vEl);
  }
  row('ID', acc.id);
  row('启用', acc.enabled ? '是' : '否');
  row('成功次数', acc.success_count ?? 0, 'var(--ok)');
  row('错误次数', acc.error_count ?? 0, 'var(--danger)');
  row('刷新状态', acc.last_refresh_status || '-');
  row('刷新时间', acc.last_refresh_time || '-');
  row('clientId', acc.clientId || '-');
  row('refreshToken', acc.refreshToken ? '已设置' : '未设置');
  row('accessToken', acc.accessToken ? '已设置' : '未设置');
  row('创建时间', acc.created_at || '-');
  row('更新时间', acc.updated_at || '-');
  if (acc.other) {
    row('其他信息', JSON.stringify(acc.other));
  }
  content.appendChild(meta);

  const sep = document.createElement('div');
  sep.className = 'sep';
  content.appendChild(sep);

  const actions = document.createElement('div');
  actions.className = 'row';
  actions.style.gap = '8px';

  const toggleBtn = document.createElement('button');
  toggleBtn.className = acc.enabled ? 'btn-secondary' : '';
  toggleBtn.textContent = acc.enabled ? '禁用' : '启用';
  toggleBtn.onclick = async () => {
    await updateAccount(acc.id, { enabled: !acc.enabled });
    modal.remove();
  };

  const refreshBtn = document.createElement('button');
  refreshBtn.className = 'btn-warn';
  refreshBtn.textContent = '刷新Token';
  refreshBtn.onclick = async () => {
    await refreshAccount(acc.id);
    modal.remove();
  };

  const delBtn = document.createElement('button');
  delBtn.className = 'btn-danger';
  delBtn.textContent = '删除';
  delBtn.onclick = async () => {
    if (confirm('确认删除该账号？')) {
      await deleteAccount(acc.id);
      modal.remove();
    }
  };

  actions.appendChild(toggleBtn);
  actions.appendChild(refreshBtn);
  actions.appendChild(delBtn);
  content.appendChild(actions);

  modal.appendChild(content);
  document.body.appendChild(modal);
}

// Virtual scroll implementation with auto height adjustment
class VirtualScroll {
  constructor(container, items, itemHeight, bufferSize = 3) {
    this.container = container;
    this.items = items;
    this.itemHeight = itemHeight;
    this.bufferSize = bufferSize;
    this.visibleStart = 0;
    this.visibleEnd = 0;
    this.renderedItems = new Map();
    this.measuredHeights = new Map();
    this.heightAdjusted = false;
    
    this.viewport = document.createElement('div');
    this.viewport.className = 'list-viewport';
    this.content = document.createElement('div');
    this.content.className = 'list-content';
    this.viewport.appendChild(this.content);
    
    this.container.innerHTML = '';
    this.container.appendChild(this.viewport);
    
    this.container.addEventListener('scroll', () => this.onScroll());
    this.render();
    
    // Auto-measure after first render
    requestAnimationFrame(() => this.measureAndAdjust());
  }
  
  onScroll() {
    requestAnimationFrame(() => this.render());
  }
  
  measureAndAdjust() {
    let maxHeight = 0;
    let needsAdjustment = false;
    
    // Measure all currently rendered items
    for (const [idx, element] of this.renderedItems.entries()) {
      const rect = element.getBoundingClientRect();
      const actualHeight = rect.height + 12; // +12 for gap
      this.measuredHeights.set(idx, actualHeight);
      
      if (actualHeight > maxHeight) {
        maxHeight = actualHeight;
      }
      
      // Check if actual height exceeds estimated height
      if (actualHeight > this.itemHeight * 0.95) {
        needsAdjustment = true;
      }
    }
    
    // Auto-adjust if needed
    if (needsAdjustment && maxHeight > this.itemHeight) {
      console.log(`[VirtualScroll] 检测到重影，调整高度: ${this.itemHeight}px -> ${Math.ceil(maxHeight)}px`);
      this.itemHeight = Math.ceil(maxHeight);
      this.heightAdjusted = true;
      
      // Re-render with new height
      this.reposition();
    }
  }
  
  reposition() {
    // Reposition all rendered items with new height
    for (const [idx, element] of this.renderedItems.entries()) {
      element.style.top = (idx * this.itemHeight) + 'px';
    }
    
    // Update viewport height
    this.viewport.style.height = (this.items.length * this.itemHeight) + 'px';
  }
  
  render() {
    const scrollTop = this.container.scrollTop;
    const containerHeight = this.container.clientHeight;
    
    const start = Math.floor(scrollTop / this.itemHeight);
    const end = Math.ceil((scrollTop + containerHeight) / this.itemHeight);
    
    const bufferedStart = Math.max(0, start - this.bufferSize);
    const bufferedEnd = Math.min(this.items.length, end + this.bufferSize);
    
    if (bufferedStart === this.visibleStart && bufferedEnd === this.visibleEnd) {
      return;
    }
    
    this.visibleStart = bufferedStart;
    this.visibleEnd = bufferedEnd;
    
    // Set viewport height
    this.viewport.style.height = (this.items.length * this.itemHeight) + 'px';
    
    // Remove items outside visible range
    for (const [idx, element] of this.renderedItems.entries()) {
      if (idx < bufferedStart || idx >= bufferedEnd) {
        element.remove();
        this.renderedItems.delete(idx);
      }
    }
    
    // Add items in visible range
    const fragment = document.createDocumentFragment();
    let newItemsAdded = false;
    
    for (let i = bufferedStart; i < bufferedEnd; i++) {
      if (!this.renderedItems.has(i)) {
        const item = createAccountCard(this.items[i]);
        item.style.position = 'absolute';
        item.style.top = (i * this.itemHeight) + 'px';
        item.style.left = '0';
        item.style.right = '0';
        this.renderedItems.set(i, item);
        fragment.appendChild(item);
        newItemsAdded = true;
      }
    }
    
    if (fragment.childNodes.length > 0) {
      this.content.appendChild(fragment);
      
      // Measure new items after they're added to DOM
      if (newItemsAdded && !this.heightAdjusted) {
        requestAnimationFrame(() => this.measureAndAdjust());
      }
    }
  }
  
  update(items) {
    this.items = items;
    this.renderedItems.clear();
    this.measuredHeights.clear();
    this.heightAdjusted = false;
    this.content.innerHTML = '';
    this.visibleStart = -1; // Force re-render
    this.visibleEnd = -1;
    requestAnimationFrame(() => {
      this.render();
      this.measureAndAdjust();
    });
  }
  
  destroy() {
    this.container.removeEventListener('scroll', this.onScroll);
    this.renderedItems.clear();
    this.measuredHeights.clear();
  }
}

function renderAccounts(list){
  accountsData = list;
  const root = document.getElementById('accounts');
  root.innerHTML = '';

  if (!Array.isArray(list) || list.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '暂无账号';
    root.appendChild(empty);
    return;
  }

  const grid = document.createElement('div');
  grid.className = 'accounts-grid';

  list.forEach(acc => {
    grid.appendChild(createAccountCard(acc));
  });

  root.appendChild(grid);
}

// --- API Actions ---

async function loadAccounts() {
  try {
    const r = await authFetch(api('/v2/accounts'));
    const j = await r.json();
    renderTable(j);
  } catch (e) {
    console.error(e); // Silent fail or show toast
  }
}

async function toggleAccount(id, enabled) {
  try {
    await authFetch(api(`/v2/accounts/${encodeURIComponent(id)}`), {
      method: 'PATCH',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ enabled })
    });
    // Don't reload full list to keep UI smooth, state is local anyway
  } catch (e) {
    alert('更新状态失败');
    loadAccounts(); // Revert
  }
}

async function refreshAccount(id) {
  try {
    const r = await authFetch(api(`/v2/accounts/${encodeURIComponent(id)}/refresh`), { method: 'POST' });
    if (!r.ok) throw new Error(await r.text());
    await loadAccounts();
  } catch(e) { alert('刷新失败: ' + e); }
}

async function deleteAccount(id) {
  if (!confirm('确认删除该账号？此操作不可恢复。')) return;
  try {
    const r = await authFetch(api(`/v2/accounts/${encodeURIComponent(id)}`), { method: 'DELETE' });
    if (!r.ok) throw new Error(await r.text());
    await loadAccounts();
  } catch(e) { alert('删除失败: ' + e); }
}

async function createAccount() {
  const body = {
    label: document.getElementById('new_label').value.trim() || null,
    clientId: document.getElementById('new_clientId').value.trim(),
    clientSecret: document.getElementById('new_clientSecret').value.trim(),
    refreshToken: document.getElementById('new_refreshToken').value.trim() || null,
    accessToken: document.getElementById('new_accessToken').value.trim() || null,
    enabled: document.getElementById('new_enabled').checked,
    other: (() => {
      const t = document.getElementById('new_other').value.trim();
      if (!t) return null;
      try { return JSON.parse(t); } catch { alert('Metadata JSON 格式错误'); throw new Error('bad json'); }
    })()
  };

  try {
    const r = await authFetch(api('/v2/accounts'), {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error(await r.text());
    alert('创建成功');
    document.getElementById('new_clientId').value = ''; // Clear secret fields
    document.getElementById('new_clientSecret').value = '';
    switchTab('accounts');
    loadAccounts();
  } catch (e) { alert('创建失败: ' + e); }
}

// --- Edit Modal ---
function openEditModal(acc) {
  editingId = acc.id;
  document.getElementById('edit_label').value = acc.label || '';
  document.getElementById('edit_accessToken').value = '';
  document.getElementById('edit-modal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.remove('open');
  editingId = null;
}

async function submitEdit() {
  if (!editingId) return;
  const label = document.getElementById('edit_label').value.trim();
  const at = document.getElementById('edit_accessToken').value.trim();
  
  const patch = { label };
  if (at) patch.accessToken = at;

  try {
    const r = await authFetch(api(`/v2/accounts/${encodeURIComponent(editingId)}`), {
      method: 'PATCH',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(patch)
    });
    if (!r.ok) throw new Error(await r.text());
    closeEditModal();
    loadAccounts();
  } catch(e) { alert('修改失败: ' + e); }
}

async function refreshAccount(id){
  try{
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(id) + '/refresh'), { method:'POST' });
    if (!r.ok) { throw new Error(await r.text()); }
    await loadAccounts();
  } catch(e){
    alert('刷新失败：' + e);
  }
}

async function exportAccounts(){
  try{
    const r = await authFetch(api('/v2/accounts/export/json'));
    if (!r.ok) { throw new Error(await r.text()); }
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'accounts.json';
    a.click();
    URL.revokeObjectURL(url);
  } catch(e){
    alert('导出失败：' + e);
  }
}

async function importAccounts(event){
  const file = event.target.files[0];
  if (!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    const r = await authFetch(api('/v2/accounts/import/json'), {
      method:'POST',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(data)
    });
    if (!r.ok) { throw new Error(await r.text()); }
    const result = await r.json();
    alert(`成功导入 ${result.imported} 个账号`);
    await loadAccounts();
  } catch(e){
    alert('导入失败：' + e);
  } finally {
    event.target.value = '';
  }
}

 // URL Login (Device Authorization)
 let currentAuth = null;
 async function startAuth(){
   const body = {
     label: (document.getElementById('auth_label').value || '').trim() || null,
     enabled: true
   };
   try {
     const r = await authFetch(api('/v2/auth/start'), {
       method: 'POST',
       headers: { 'content-type': 'application/json' },
       body: JSON.stringify(body)
     });
     if (!r.ok) throw new Error(await r.text());
     const j = await r.json();
     currentAuth = j;
     const el = document.getElementById('auth_info');
     el.innerHTML = `验证链接: <a href="${j.verificationUriComplete}" target="_blank" style="color:var(--accent)">点击这里登录</a>\n` +
                    `用户代码: ${j.userCode || ''}\n` +
                    `Auth ID:  ${j.authId}`;
     window.open(j.verificationUriComplete, '_blank');
   } catch(e){
     document.getElementById('auth_info').textContent = '启动失败：' + e;
   }
}

async function claimAuth(){
   if (!currentAuth || !currentAuth.authId) {
     alert('请先点击“获取登录链接”');
     return;
   }
   const el = document.getElementById('auth_info');
   el.textContent += '\n\n正在轮询/等待授权...';
   try{
     const r = await authFetch(api('/v2/auth/claim/' + encodeURIComponent(currentAuth.authId)), { method: 'POST' });
     const text = await r.text();
     el.textContent = '完成！服务器响应：\n' + text;
     loadAccounts();
   } catch(e){
     el.textContent += '\n失败：' + e;
   }
}

async function send() {
  const model = document.getElementById('model').value.trim();
  const stream = document.getElementById('stream').value === 'true';
  const out = document.getElementById('out');
  out.textContent = 'Thinking...';

  let messages;
  try { messages = JSON.parse(document.getElementById('messages').value); }
  catch(e){ out.textContent = 'JSON 格式错误'; return; }

  const body = { model, messages, stream };
  const headers = { 'content-type': 'application/json' };

  try {
    if (!stream) {
      const r = await authFetch(api('/v1/chat/completions'), { method:'POST', headers, body: JSON.stringify(body) });
      const text = await r.text();
      try { out.textContent = JSON.stringify(JSON.parse(text), null, 2); }
      catch { out.textContent = text; }
    } else {
      const r = await authFetch(api('/v1/chat/completions'), { method:'POST', headers, body: JSON.stringify(body) });
      out.textContent = '';
      const reader = r.body.getReader();
      const decoder = new TextDecoder();
      while (true) {
        const {value, done} = await reader.read();
        if (done) break;
        out.textContent += decoder.decode(value, {stream:true});
      }
    }
  } catch (e) {
    out.textContent = '请求错误: ' + e;
  }
}

// Init
window.addEventListener('DOMContentLoaded', () => {
  if (!localStorage.getItem('adminPassword')) {
    window.location.href = '/login.html'; // 记得确保文件名匹配
  } else {
    loadAccounts();
  }
});

</script>
</body>
</html>
