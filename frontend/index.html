<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>Q2API · Console by 张扬2025年11月28日17:09:54</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      /* 调色盘：深夜霓虹 */
      --bg-body: #030711;
      --bg-panel: rgba(18, 24, 38, 0.9);
      --bg-subtle: #101727;
      
      --border: rgba(255, 255, 255, 0.08);
      --border-subtle: rgba(255, 255, 255, 0.05);
      
      --text-main: #f8fafc;
      --text-muted: #9ba3b4;
      --text-dim: #5f6880;

      --accent: #22d3ee; /* 青蓝 */
      --accent-2: #7cfb6b; /* 荧光绿 */
      --accent-hover: #0ea5e9;
      --accent-glow: rgba(34, 211, 238, 0.24);

      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
    }

    /* 基础重置 */
    * { box-sizing: border-box; outline: none; }
    html, body { height: 100%; margin: 0; }
    
    body {
      background: radial-gradient(circle at 10% 20%, rgba(34, 211, 238, 0.12), transparent 26%),
                  radial-gradient(circle at 80% 0%, rgba(124, 251, 107, 0.14), transparent 30%),
                  radial-gradient(circle at 50% 80%, rgba(14, 165, 233, 0.18), transparent 28%),
                  var(--bg-body);
      color: var(--text-main);
      font-family: "Sora", "Space Grotesk", "Inter", ui-sans-serif, system-ui, -apple-system, sans-serif;
      line-height: 1.55;
      font-size: 14px;
      padding-bottom: 48px;
      letter-spacing: 0.01em;
    }

    /* 布局容器 */
    .container {
      max-width: 1360px;
      margin: 0 auto;
      padding: 28px 24px 0;
    }

    /* 头部区域 */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-subtle);
    }

    h1 {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.6px;
      margin: 0;
      background: linear-gradient(120deg, #e2f3ff, #9ae6ff 45%, #7cfb6b 90%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-transform: uppercase;
    }

    /* 导航 Tabs - 胶囊风格 */
    .nav-tabs {
      display: inline-flex;
      background: rgba(255, 255, 255, 0.05);
      padding: 5px;
      border-radius: 999px;
      gap: 4px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    }

    .tab-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.03em;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:hover { color: var(--text-main); transform: translateY(-1px); }
    .tab-btn.active {
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(124, 251, 107, 0.2));
      color: var(--text-main);
      box-shadow: 0 12px 35px rgba(34, 211, 238, 0.25);
      border: 1px solid rgba(124, 251, 107, 0.2);
    }

    /* 内容面板 */
    .tab-pane { display: none; animation: fadeIn 0.3s ease; }
    .tab-pane.active { display: block; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .panel {
      position: relative;
      background: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      overflow: hidden;
      backdrop-filter: blur(8px);
    }
    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.07), transparent 38%),
                  radial-gradient(circle at 90% 10%, rgba(124, 251, 107, 0.07), transparent 32%);
      opacity: 0.9;
      pointer-events: none;
    }
    .panel > * { position: relative; z-index: 1; }

    /* ---------------- 表格样式 (核心修改) ---------------- */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(255,255,255,0.01);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      text-align: left;
    }

    thead {
      background: linear-gradient(90deg, rgba(34, 211, 238, 0.12), rgba(124, 251, 107, 0.08));
    }

    th {
      padding: 12px 16px;
      color: var(--text-muted);
      font-weight: 600;
      white-space: nowrap;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-subtle);
      color: var(--text-main);
      vertical-align: middle;
    }

    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(34,211,238,0.04); }

    /* 表格中的特定列样式 */
    .col-id { font-family: 'SFMono-Regular', Consolas, monospace; color: var(--text-muted); font-size: 12px; }
    .col-label { font-weight: 700; color: #f8fafc; letter-spacing: 0.01em; }
    .col-actions { display: flex; gap: 8px; }

    /* 状态指示器 */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 99px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
    .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
    .badge-neutral { background: rgba(161, 161, 170, 0.15); color: var(--text-muted); border: 1px solid rgba(161, 161, 170, 0.2); }

    .token-dot {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--border);
      margin-right: 4px;
    }
    .token-dot.active { background: var(--success); box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }

    /* 按钮样式 */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 16px;
      border-radius: var(--radius-md);
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
      gap: 6px;
      letter-spacing: 0.02em;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      color: #041018;
      box-shadow: 0 10px 30px rgba(34, 211, 238, 0.35);
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 14px 36px rgba(34, 211, 238, 0.42); }
    
    .btn-ghost { background: rgba(255,255,255,0.04); color: var(--text-main); border: 1px solid var(--border); }
    .btn-ghost:hover { background: rgba(255,255,255,0.07); border-color: rgba(255,255,255,0.12); }

    .btn-icon { padding: 7px; border-radius: var(--radius-sm); color: var(--text-muted); background: rgba(255,255,255,0.03); border: 1px solid var(--border); }
    .btn-icon:hover { background: rgba(255,255,255,0.08); color: var(--text-main); transform: translateY(-1px); }
    .btn-icon.danger:hover { background: rgba(239, 68, 68, 0.12); color: var(--danger); }

    /* 开关 (Switch) */
    .switch {
      position: relative;
      display: inline-block;
      width: 36px;
      height: 20px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: var(--border);
      transition: .3s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px; width: 16px;
      left: 2px; bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--success); }
    input:checked + .slider:before { transform: translateX(16px); }

    /* 表单元素 */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    label { color: var(--text-muted); font-size: 12px; font-weight: 600; }
    input, textarea, select {
      background: var(--bg-body);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 10px 12px;
      border-radius: var(--radius-md);
      font-size: 14px;
      transition: border 0.2s;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
    textarea { min-height: 100px; font-family: 'SFMono-Regular', monospace; font-size: 12px; }

    /* 模态框 (Modal) */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--bg-panel);
      width: 100%; max-width: 500px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 24px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }
    .modal-header { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; }
    .modal-footer { margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px; }

    /* 工具类 */
    .text-mono { font-family: 'SFMono-Regular', monospace; }
    .flex-row { display: flex; gap: 12px; align-items: center; }
    .spacer { flex: 1; }
    
    /* Code block for chat */
    .code-preview {
      background: #0d0d0d;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      color: #a8b8d8;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }

  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Q2API Console by zhang</h1>
    <div class="nav-tabs">
      <button class="tab-btn active" onclick="switchTab('accounts')">账号列表</button>
      <button class="tab-btn" onclick="switchTab('create')">新建账号</button>
      <button class="tab-btn" onclick="switchTab('login')">URL 登录</button>
      <button class="tab-btn" onclick="switchTab('chat')">Chat 调试</button>
    </div>
  </header>

  <!-- Tab: 账号列表 -->
  <div id="tab-accounts" class="tab-pane active">
    <div class="panel">
      <div class="flex-row" style="margin-bottom: 20px;">
        <h2 style="margin:0; font-size:16px;">所有账号</h2>
        <div class="spacer"></div>
        <button class="btn btn-ghost" onclick="loadAccounts()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          刷新
        </button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width: 50px">状态</th>
              <th>标签 (Label)</th>
              <th>Client ID / ID</th>
              <th>Tokens</th>
              <th>统计 (成功/失败)</th>
              <th style="text-align: right">操作</th>
            </tr>
          </thead>
          <tbody id="accounts-table-body">
            <!-- JS 渲染 -->
          </tbody>
        </table>
      </div>
      <div id="empty-state" style="text-align:center; padding: 40px; color: var(--text-muted); display:none;">
        暂无账号数据
      </div>
    </div>
  </div>

  <!-- Tab: 新建账号 -->
  <div id="tab-create" class="tab-pane">
    <div class="panel" style="max-width: 800px; margin: 0 auto;">
      <h2 style="margin-bottom:24px;">手动添加账号</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>Label (标签)</label>
          <input id="new_label" placeholder="例如: My Personal Key" />
        </div>
        <div class="form-group">
           <label>启用状态</label>
           <div class="flex-row">
             <label class="switch">
               <input id="new_enabled" type="checkbox" checked />
               <span class="slider"></span>
             </label>
             <span style="font-size:12px; color:var(--text-muted)">仅启用账号会被调度</span>
           </div>
        </div>
        <div class="form-group">
          <label>Client ID</label>
          <input id="new_clientId" class="text-mono" />
        </div>
        <div class="form-group">
          <label>Client Secret</label>
          <input id="new_clientSecret" type="password" class="text-mono" />
        </div>
        <div class="form-group">
          <label>Refresh Token</label>
          <input id="new_refreshToken" class="text-mono" />
        </div>
        <div class="form-group">
          <label>Access Token</label>
          <input id="new_accessToken" class="text-mono" />
        </div>
        <div class="form-group" style="grid-column: 1/-1;">
          <label>Metadata (JSON)</label>
          <textarea id="new_other" placeholder='{"note": "备注信息"}'></textarea>
        </div>
      </div>
      <div style="margin-top: 24px; text-align: right;">
        <button class="btn btn-primary" onclick="createAccount()">创建账号</button>
      </div>
    </div>
  </div>

  <!-- Tab: URL 登录 -->
  <div id="tab-login" class="tab-pane">
    <div class="panel" style="max-width: 600px; margin: 0 auto;">
      <h2 style="margin-bottom: 20px;">Device Code Login</h2>
      <div class="form-group" style="margin-bottom: 20px;">
        <label>新建账号标签</label>
        <input id="auth_label" placeholder="自动登录账号" />
      </div>
      <div class="flex-row" style="margin-bottom: 24px;">
        <button class="btn btn-primary" onclick="startAuth()">1. 获取登录链接</button>
        <button class="btn btn-ghost" onclick="claimAuth()">2. 我已登录，获取 Token</button>
      </div>
      
      <div class="code-preview" id="auth_info">等待操作...</div>
    </div>
  </div>

  <!-- Tab: Chat 测试 -->
  <div id="tab-chat" class="tab-pane">
    <div class="panel">
      <div class="flex-row" style="margin-bottom: 20px;">
        <div class="form-group" style="width: 200px;">
          <label>Model</label>
          <input id="model" value="claude-sonnet-4" />
        </div>
        <div class="form-group">
          <label>Stream</label>
          <select id="stream">
            <option value="false">关闭 (Block)</option>
            <option value="true">开启 (SSE)</option>
          </select>
        </div>
        <div class="spacer"></div>
        <button class="btn btn-primary" onclick="send()">发送请求</button>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
          <label>Messages (JSON)</label>
          <textarea id="messages" style="height: 400px; font-family: monospace;">[
  {"role":"system","content":"你是一个乐于助人的助手"},
  {"role":"user","content":"你好，请用一句话介绍你自己"}
]</textarea>
        </div>
        <div class="form-group">
          <label>Response</label>
          <div id="out" class="code-preview" style="height: 400px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 编辑模态框 -->
<div id="edit-modal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <span>编辑账号</span>
      <button class="btn-icon" onclick="closeEditModal()">✕</button>
    </div>
    <div class="form-group" style="margin-bottom:16px;">
      <label>Label</label>
      <input id="edit_label" />
    </div>
    <div class="form-group" style="margin-bottom:16px;">
      <label>Access Token (覆盖)</label>
      <input id="edit_accessToken" class="text-mono" placeholder="留空则不修改" />
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeEditModal()">取消</button>
      <button class="btn btn-primary" onclick="submitEdit()">保存修改</button>
    </div>
  </div>
</div>

<script>
// --- 基础工具 ---
function api(path) {
  return ('/' + (path || '').replace(/^\/+/, '')).replace(/\/{2,}/g, '/');
}

function getAuthHeaders() {
  const p = localStorage.getItem('adminPassword');
  return p ? { 'Authorization': `Bearer ${p}` } : {};
}

async function authFetch(url, options = {}) {
  const headers = { ...getAuthHeaders(), ...options.headers };
  const r = await fetch(url, { ...options, headers });
  if (r.status === 401) {
    localStorage.removeItem('adminPassword');
    window.location.href = '/login.html'; // 假设你的登录页是 login.html
    throw new Error('Unauthorized');
  }
  return r;
}

// --- 页面逻辑 ---
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  
  // 简单的事件委托查找或直接匹配
  const btns = document.querySelectorAll('.tab-btn');
  // 这里的逻辑稍微简化，依赖 HTML 结构顺序或点击事件
  event.target.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

// --- 账号管理 (表格渲染) ---
let currentAccounts = [];
let editingId = null;

function renderTable(list) {
  currentAccounts = list;
  const tbody = document.getElementById('accounts-table-body');
  const empty = document.getElementById('empty-state');
  tbody.innerHTML = '';

  if (!list || list.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  list.forEach(acc => {
    const tr = document.createElement('tr');
    
    // 状态开关
    const statusCell = document.createElement('td');
    const switchLabel = document.createElement('label');
    switchLabel.className = 'switch';
    const inp = document.createElement('input');
    inp.type = 'checkbox';
    inp.checked = !!acc.enabled;
    inp.onchange = () => toggleAccount(acc.id, inp.checked);
    const slider = document.createElement('span');
    slider.className = 'slider';
    switchLabel.append(inp, slider);
    statusCell.appendChild(switchLabel);

    // Label
    const labelCell = document.createElement('td');
    labelCell.innerHTML = `<div class="col-label">${acc.label || '<span style="opacity:0.5">未命名</span>'}</div>
                           <div class="text-mono" style="font-size:11px; color:var(--text-dim)">Created: ${new Date(acc.created_at || Date.now()).toLocaleDateString()}</div>`;

    // ID
    const idCell = document.createElement('td');
    idCell.className = 'col-id';
    idCell.textContent = acc.id.substring(0, 8) + '...';
    idCell.title = acc.id; // Tooltip full ID

    // Tokens
    const tokenCell = document.createElement('td');
    tokenCell.innerHTML = `
      <div style="font-size:12px; display:flex; align-items:center;">
        <span class="token-dot ${acc.refreshToken ? 'active' : ''}" title="Refresh Token"></span> R
        <span style="width:8px"></span>
        <span class="token-dot ${acc.accessToken ? 'active' : ''}" title="Access Token"></span> A
      </div>
      <div style="font-size:11px; color:var(--text-dim); margin-top:4px;">Last: ${acc.last_refresh_status || '-'}</div>
    `;

    // Stats
    const statsCell = document.createElement('td');
    statsCell.innerHTML = `
      <span class="badge badge-success">${acc.success_count || 0}</span>
      <span class="badge badge-danger">${acc.error_count || 0}</span>
    `;

    // Actions
    const actionCell = document.createElement('td');
    actionCell.className = 'col-actions';
    actionCell.style.textAlign = 'right';
    
    const btnRefresh = document.createElement('button');
    btnRefresh.className = 'btn-icon';
    btnRefresh.title = '刷新 Token';
    btnRefresh.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';
    btnRefresh.onclick = () => refreshAccount(acc.id);

    const btnEdit = document.createElement('button');
    btnEdit.className = 'btn-icon';
    btnEdit.title = '编辑';
    btnEdit.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
    btnEdit.onclick = () => openEditModal(acc);

    const btnDel = document.createElement('button');
    btnDel.className = 'btn-icon danger';
    btnDel.title = '删除';
    btnDel.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
    btnDel.onclick = () => deleteAccount(acc.id);

    actionCell.append(btnRefresh, btnEdit, btnDel);

    tr.append(statusCell, labelCell, idCell, tokenCell, statsCell, actionCell);
    tbody.appendChild(tr);
  });
}

// --- API Actions ---

async function loadAccounts() {
  try {
    const r = await authFetch(api('/v2/accounts'));
    const j = await r.json();
    renderTable(j);
  } catch (e) {
    console.error(e); // Silent fail or show toast
  }
}

async function toggleAccount(id, enabled) {
  try {
    await authFetch(api(`/v2/accounts/${encodeURIComponent(id)}`), {
      method: 'PATCH',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ enabled })
    });
    // Don't reload full list to keep UI smooth, state is local anyway
  } catch (e) {
    alert('更新状态失败');
    loadAccounts(); // Revert
  }
}

async function refreshAccount(id) {
  try {
    const r = await authFetch(api(`/v2/accounts/${encodeURIComponent(id)}/refresh`), { method: 'POST' });
    if (!r.ok) throw new Error(await r.text());
    await loadAccounts();
  } catch(e) { alert('刷新失败: ' + e); }
}

async function deleteAccount(id) {
  if (!confirm('确认删除该账号？此操作不可恢复。')) return;
  try {
    const r = await authFetch(api(`/v2/accounts/${encodeURIComponent(id)}`), { method: 'DELETE' });
    if (!r.ok) throw new Error(await r.text());
    await loadAccounts();
  } catch(e) { alert('删除失败: ' + e); }
}

async function createAccount() {
  const body = {
    label: document.getElementById('new_label').value.trim() || null,
    clientId: document.getElementById('new_clientId').value.trim(),
    clientSecret: document.getElementById('new_clientSecret').value.trim(),
    refreshToken: document.getElementById('new_refreshToken').value.trim() || null,
    accessToken: document.getElementById('new_accessToken').value.trim() || null,
    enabled: document.getElementById('new_enabled').checked,
    other: (() => {
      const t = document.getElementById('new_other').value.trim();
      if (!t) return null;
      try { return JSON.parse(t); } catch { alert('Metadata JSON 格式错误'); throw new Error('bad json'); }
    })()
  };

  try {
    const r = await authFetch(api('/v2/accounts'), {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error(await r.text());
    alert('创建成功');
    document.getElementById('new_clientId').value = ''; // Clear secret fields
    document.getElementById('new_clientSecret').value = '';
    switchTab('accounts');
    loadAccounts();
  } catch (e) { alert('创建失败: ' + e); }
}

// --- Edit Modal ---
function openEditModal(acc) {
  editingId = acc.id;
  document.getElementById('edit_label').value = acc.label || '';
  document.getElementById('edit_accessToken').value = '';
  document.getElementById('edit-modal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.remove('open');
  editingId = null;
}

async function submitEdit() {
  if (!editingId) return;
  const label = document.getElementById('edit_label').value.trim();
  const at = document.getElementById('edit_accessToken').value.trim();
  
  const patch = { label };
  if (at) patch.accessToken = at;

  try {
    const r = await authFetch(api(`/v2/accounts/${encodeURIComponent(editingId)}`), {
      method: 'PATCH',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(patch)
    });
    if (!r.ok) throw new Error(await r.text());
    closeEditModal();
    loadAccounts();
  } catch(e) { alert('修改失败: ' + e); }
}

// --- Login & Chat (Existing Logic Preserved) ---
let currentAuth = null;
async function startAuth(){
   const body = {
     label: (document.getElementById('auth_label').value || '').trim() || null,
     enabled: true
   };
   try {
     const r = await authFetch(api('/v2/auth/start'), {
       method: 'POST',
       headers: { 'content-type': 'application/json' },
       body: JSON.stringify(body)
     });
     if (!r.ok) throw new Error(await r.text());
     const j = await r.json();
     currentAuth = j;
     const el = document.getElementById('auth_info');
     el.innerHTML = `验证链接: <a href="${j.verificationUriComplete}" target="_blank" style="color:var(--accent)">点击这里登录</a>\n` +
                    `用户代码: ${j.userCode || ''}\n` +
                    `Auth ID:  ${j.authId}`;
     window.open(j.verificationUriComplete, '_blank');
   } catch(e){
     document.getElementById('auth_info').textContent = '启动失败：' + e;
   }
}

async function claimAuth(){
   if (!currentAuth || !currentAuth.authId) {
     alert('请先点击“获取登录链接”');
     return;
   }
   const el = document.getElementById('auth_info');
   el.textContent += '\n\n正在轮询/等待授权...';
   try{
     const r = await authFetch(api('/v2/auth/claim/' + encodeURIComponent(currentAuth.authId)), { method: 'POST' });
     const text = await r.text();
     el.textContent = '完成！服务器响应：\n' + text;
     loadAccounts();
   } catch(e){
     el.textContent += '\n失败：' + e;
   }
}

async function send() {
  const model = document.getElementById('model').value.trim();
  const stream = document.getElementById('stream').value === 'true';
  const out = document.getElementById('out');
  out.textContent = 'Thinking...';

  let messages;
  try { messages = JSON.parse(document.getElementById('messages').value); }
  catch(e){ out.textContent = 'JSON 格式错误'; return; }

  const body = { model, messages, stream };
  const headers = { 'content-type': 'application/json' };

  try {
    if (!stream) {
      const r = await authFetch(api('/v1/chat/completions'), { method:'POST', headers, body: JSON.stringify(body) });
      const text = await r.text();
      try { out.textContent = JSON.stringify(JSON.parse(text), null, 2); }
      catch { out.textContent = text; }
    } else {
      const r = await authFetch(api('/v1/chat/completions'), { method:'POST', headers, body: JSON.stringify(body) });
      out.textContent = '';
      const reader = r.body.getReader();
      const decoder = new TextDecoder();
      while (true) {
        const {value, done} = await reader.read();
        if (done) break;
        out.textContent += decoder.decode(value, {stream:true});
      }
    }
  } catch (e) {
    out.textContent = '请求错误: ' + e;
  }
}

// Init
window.addEventListener('DOMContentLoaded', () => {
  if (!localStorage.getItem('adminPassword')) {
    window.location.href = '/login.html'; // 记得确保文件名匹配
  } else {
    loadAccounts();
  }
});

</script>
</body>
</html>
